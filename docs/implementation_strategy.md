# Sornette対数周期パターンによる破滅的事象予測システム - 実装方針書

## 🚨 **最重要原則: 論文再現の絶対保護**

**⚠️ この原則はすべての実装・変更に優先します**

### 科学的根幹の保護
```
Sornette論文のLPPLモデル実装は本システムの科学的根幹であり、
いかなる機能追加・改修・最適化においても破損させてはいけません。
```

### 必須検証プロトコル
**すべての変更前後で以下を実行**:
```bash
python tests/historical_crashes/black_monday_1987_validator.py
```
- **期待結果**: 予測可能性スコア 100/100
- **破損時**: 即座にgit revertで変更を巻き戻し

### 保護対象
- `src/fitting/` 以下のフィッティングアルゴリズム
- `logarithm_periodic_func` 関数（論文数式の実装）
- 歴史的クラッシュ検証システム
- 1987年ブラックマンデー検証（100/100スコア必須）

## プロジェクト概要

### 最終目標
Didier Sornetteの対数周期パワー法則モデルを実装し、金融市場・仮想通貨・その他の分野で破滅的事象（クラッシュ）を予測して実際に収益を上げること。

### 基本戦略
1. **科学的正確性を優先** - 論文に基づく正確な数式実装
2. **段階的実装** - 動く最小実装から始めて機能拡張
3. **自動化システム** - ローカルサーバーでの継続的監視
4. **収益化重視** - 予測精度向上と実際のトレーディング戦略構築

## 技術的実装方針

### コア数式の実装
基本的な対数周期パワー法則モデル：
```
I(t) = A + B(tc - t)^β + C(tc - t)^β cos(ω ln(tc - t) - φ)
```

### 実装アーキテクチャ（現在の4層構造）
```
sornette_prediction/
├── 🧠 core/                    # 【保護対象】科学的中核理論
│   ├── sornette_theory/        # 純粋なSornette LPPL実装
│   ├── fitting/                # フィッティングアルゴリズム
│   └── validation/             # 歴史的検証（100/100スコア保護）
│
├── 🔧 applications/            # アプリケーション層
│   ├── analysis_tools/         # 解析ツール（scheduled_analyzer等）
│   ├── dashboards/             # Webインターフェース
│   └── examples/               # 実行例・デモ
│
├── 🔍 infrastructure/          # インフラ・サポート
│   ├── data_sources/           # データ取得（unified_data_client）
│   ├── database/               # データベース管理（SQLite）
│   ├── error_handling/         # エラーハンドリングシステム
│   └── visualization/          # 可視化サポート
│
└── 🎯 entry_points/            # 統一エントリポイント
    └── main.py                 # メインコマンドインターフェース
```

### 📅 スケジュール分析システム（新規実装）
```
スケジュール管理の基本概念:
- Source×Frequency分離: データソース（fred/alpha_vantage）と頻度（weekly/daily）を独立管理
- 分析基準日 (Analysis Basis Date): 分析対象期間の最終日を基準とした日付管理
- 曜日メタデータ: 混在する頻度データの適切な表示・選択を支援
- 自動バックフィル: 指定期間の欠損データを適切な曜日で自動補完
```

### 開発プロセス
1. **Phase 1** ✅: 基本モデルの実装と検証（1987年、1929年データでの再現）
2. **Phase 2** ✅: リアルタイムデータ取得とモニタリングシステム
3. **Phase 2.5** ✅: スケジュール分析システム（自動定期解析・バックフィル機能）
4. **Phase 3**: 取引戦略の実装とバックテスト
5. **Phase 4**: 他市場（仮想通貨、不動産など）への展開

### ⚙️ データベース設計（最新版）
```sql
-- 分析結果テーブル（拡張済み）
analysis_results:
  - analysis_basis_date (DATE): 分析対象期間の最終日【重要】
  - basis_day_of_week (INTEGER): 曜日メタデータ (0=月曜, 6=日曜)
  - analysis_frequency (TEXT): 解析頻度 ('weekly', 'daily')
  - schedule_name (TEXT): スケジュール識別子
  - is_scheduled (BOOLEAN): スケジュール実行フラグ
  - backfill_batch_id (TEXT): バックフィル実行バッチID

-- スケジュール設定テーブル（新規）
schedule_config:
  - schedule_name (TEXT): 'fred_weekly', 'alpha_vantage_daily'
  - frequency (TEXT): 'weekly', 'daily' 
  - day_of_week (INTEGER): 実行曜日（週次の場合）
  - symbols (JSON): 対象銘柄リスト
  - auto_backfill_limit (INTEGER): 自動バックフィル日数制限
```

## 品質管理方針

### テスト戦略
- 論文データの完全再現を必須とする
- フィッティング精度の定量的評価
- 統計的有意性の検証

### パフォーマンス要件
- リアルタイム分析は5分以内で完了
- 過去データのバックテストは効率的な実装
- メモリ使用量の最適化

### エラーハンドリング
- データ取得失敗時の適切な処理
- パラメータフィッティング失敗時のフォールバック
- ログ出力による問題追跡

## 収益化戦略

### 段階的アプローチ
1. **予測精度の向上** - バックテストでの検証
2. **リスク管理** - 適切なポジションサイジング
3. **自動取引** - 予測に基づく自動売買

### 対象市場の優先順位
1. **主要株式指数** (S&P500, 日経225など)
2. **仮想通貨** (BTC, ETH, 主要アルトコイン)
3. **個別株式** (高時価総額銘柄)
4. **その他** (REIT, 商品先物など)

## 開発環境・ツール

### 必須ライブラリ
- `numpy`, `scipy` - 数値計算
- `pandas` - データ操作
- `yfinance`, `ccxt` - 市場データ取得
- `matplotlib`, `plotly` - 可視化
- `scikit-learn` - 機械学習サポート

### 推奨開発手法
- **TDD (Test-Driven Development)** - テストファーストでの実装
- **継続的インテグレーション** - 変更時の自動テスト実行
- **文書化** - コードとアルゴリズムの詳細記述

## ユーザーの特性に基づく配慮

### ADHD特性への対応
- **明確な完了基準** - 各フェーズでの具体的なゴール設定
- **小単位タスク** - 2週間以内で完了可能なタスクに分割
- **動く最小実装** - 複雑さより実用性を優先

### 技術レベル考慮
- **中級レベル** - 生成AIとの協働を前提とした設計
- **コメント充実** - 複雑なアルゴリズムの詳細説明
- **段階的学習** - 実装を通じた理論理解の深化

## 今後の拡張性

### 市場拡張
#### 現在実装済み（Market Data Catalog v2.0）
- **米国株式指数**: NASDAQ Composite, S&P 500, Dow Jones
- **仮想通貨ETF**: Bitcoin (GBTC), Ethereum (ETHE) 
- **セクター指数**: 半導体 (SOXX), テクノロジー (XLK)
- **REIT指数**: 不動産投資信託関連
- **包括的メタデータ**: asset_class, instrument_type, market_region

#### 将来拡張候補
- 国際指数 (日経225, DAX, FTSE100)
- 債券市場
- 為替市場  
- 商品先物市場

### 技術拡張
#### 現在実装済み
- **APIレート制限管理システム**: 複数プロバイダの統一制限管理
- **インテリジェント待機**: プログレスバー付き自動待機
- **マルチ期間制限**: 分/時/日単位での制限遵守
- **永続化状態管理**: レート制限状態の自動保存・復元
- **投資級クラッシュ警告**: 4段階リスク・緊急度評価システム

#### 将来拡張候補  
- 機械学習との組み合わせ
- 高頻度取引への対応
- クラウド環境での大規模処理

### ダッシュボード設計原則 【2025-08-08更新】

#### 基本方針
- **参照専用**: 解析済みデータの表示・参照のみに特化
- **科学的正確性**: 分析基準日概念の厳密な実装・予測期間の明確化
- **多言語対応**: 英語UI（海外サブスクリプション対応・グラフ文字化け防止）
- **ユーザビリティ優先**: 直感的な操作・豊富な参照情報

#### 実装制限
- **分析実行機能**: ダッシュボードからの分析実行は禁止
- **データ管理機能**: データ削除・エクスポート等の管理機能は除外  
- **設定変更機能**: パラメータ変更等はコマンドライン経由のみ

#### 実装済み機能構成（3タブ構成）

##### 1. 📈 LPPL Fitting Analysis タブ
**メイン機能**:
- **Market Data with LPPL Predictions**: 統合プロット・最新分析基準の市場データ可視化
- **Integrated Predictions**: 期間内全予測の統合表示・縦線可視化（黒背景ラベル・日付のみ表示）
- **Individual Fitting Results**: 個別フィッティング結果・Future Period表示・最大5件制限
- **Prediction Summary**: 2指標Days to Crash表示（本日から・基準日から）

**技術的特徴**:
- **Future Period表示**: フィッティング基準日以降60日間の予測曲線
- **期間選択連動**: サイドバーAnalysis Period Selectionとの完全連動
- **科学的独立性**: Latest Analysis基準での統合予測（期間フィルタ独立）
- **パフォーマンス制限**: Individual Results 5件・20項目制限警告（上下配置）

##### 2. 📊 Prediction Convergence タブ
**メイン機能**:
- **Crash Prediction Convergence**: 散布図・フィッティング基準日vs予測クラッシュ日
- **Multi-Period Convergence Analysis**: 固定期間別収束分析（1/3/6ヶ月・1/2年）

**技術的特徴**:
- **y=x参照線**: 青・細線・実線・散布図範囲内表示
- **収束分析手法**: 標準偏差・重み付け・トレンド解析・コンセンサス予測
- **固定期間独立性**: サイドバー期間選択と独立した標準化時間窓

##### 3. 📋 Parameters & References タブ
**メイン機能**:
- **パラメータテーブル**: 全LPPL最重要パラメータ表示・CSV出力
- **Reference情報**: 3段階参照情報（Black Monday・Dot-com・General Benchmarks）

**参照情報内容**:
- **1987 Black Monday**: 100/100再現・R²0.85-0.95・β~0.33・ω~6-8
- **2000 Dot-com Bubble**: 質的検証・β0.1-0.5・ω4-12・R²0.6-0.9
- **General Benchmarks**: 品質基準・解釈ガイドライン・分類基準

#### サイドバー機能
- **銘柄選択**: Asset Category別・Symbol選択
- **期間選択**: Analysis Period Selection（From/To基準日指定）
- **表示制御**: Display Settings・期間計算・データ統計
- **Priority Filter**: データ品質による絞り込み

#### UI/UX設計原則
- **視認性**: ダークテーマ・コントラスト最適化・グリッド表示
- **予測明確化**: 縦線・Future Period・時間軸の明示
- **情報密度**: 簡潔な表示・適切なキャプション・ヘルプテキスト
- **パフォーマンス**: 制限機能・プログレッシブ表示・データ量管理

### 収益拡張
- 予測サービスの外部提供
- トレーディングアルゴリズムのライセンス
- 投資ファンドの運用